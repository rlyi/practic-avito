@model AvitoClone.Models.Ad
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    Layout = "_Layout";
    ViewData["Title"] = $"{Model.Title} - AvitoClone";
    var currentUser = HttpContextAccessor.HttpContext?.Session.GetString("CurrentUser");
    var isAuthenticated = currentUser != null;
}

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>123 - AvitoClone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .ad-img {
            max-height: 500px;
            object-fit: contain;
        }

        .ad-description {
            white-space: pre-line;
        }

        .ad-date {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* Стили для чата */
        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message-incoming {
            background-color: #e9ecef;
            margin-right: auto;
        }

        .message-outgoing {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

        .message-header {
            font-size: 0.8em;
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }

        .message-time {
            opacity: 0.7;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input textarea {
            flex-grow: 1;
            resize: none;
        }

        .disabled-chat {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h1>123</h1>
                <div class="text-muted mb-3">
                    <span>Автор: 123</span>
                    <span class="ms-3 ad-date">
                        @Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                    </span>
                    <span class="ms-3 badge bg-primary"></span>
                </div>

                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <img src="/uploads/bbc00d76-a22e-4d20-acb6-e1c538ee8e9e_c972a4e9acc6fb1c89b35e47b01b38ac.jpg" class="img-fluid ad-img mb-3">
                }

                <div class="mb-4">
                    <h3>Описание</h3>
                    <p class="ad-description">123</p>
                    <h4 class="text-success">123,00 ₽</h4>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Чат по объявлению</div>
                    <div class="card-body">
                        @if (isAuthenticated)
                        {
                            <div class="chat-container">
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Сообщения будут загружаться здесь -->
                                </div>

                                <form id="chatForm" class="chat-input">
                                    <input type="hidden" name="adId" value="@Model.Id" />
                                    <textarea class="form-control" id="messageText" rows="2"
                                    placeholder="Введите сообщение..." required></textarea>
                                    <button type="submit" class="btn btn-primary">Отправить</button>
                                </form>
                            </div>

                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                            <script>
                                $(document).ready(function () {
                                    // Функция загрузки сообщений (оставляем без изменений)
                                    function loadMessages() {
                                        $.get('/Chat/GetMessages?adId=@Model.Id', function (messages) {
                                            $('#chatMessages').empty();
                                            messages.forEach(function (msg) {
                                                const isOutgoing = msg.sender === '@currentUser';
                                                const messageClass = isOutgoing ? 'message-outgoing' : 'message-incoming';

                                                $('#chatMessages').append(`
                            <div class="message ${messageClass}">
                                <div class="message-header">
                                    <span class="message-sender">${msg.sender}</span>
                                    <span class="message-time">${msg.time}</span>
                                </div>
                                <div class="message-text">${msg.text}</div>
                            </div>
                        `);
                                            });
                                            $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
                                        });
                                    }

                                    // Новый обработчик отправки формы с fetch
                                    $('#chatForm').submit(async function (e) {
                                        e.preventDefault();

                                        const messageText = $('#messageText').val().trim();
                                        if (!messageText) return;

                                        try {
                                            const response = await fetch('/Chat/SendMessage', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                },
                                                body: JSON.stringify({
                                                    adId: @Model.Id,
                                                    text: messageText
                                                })
                                            });

                                            const data = await response.json();

                                            if (data.error) {
                                                alert(data.error);
                                                if (data.error.includes("авторизация")) {
                                                    window.location.href = '/User/Login';
                                                }
                                                return;
                                            }

                                            $('#messageText').val('');
                                            loadMessages();
                                        } catch (error) {
                                            console.error('Ошибка:', error);
                                        }
                                    });

                                    // Первоначальная загрузка сообщений
                                    loadMessages();

                                    // Автообновление чата каждые 5 секунд
                                    setInterval(loadMessages, 5000);
                                });
                            </script>
                        }
                        else
                        {
                            <div class="disabled-chat">
                                <p>Чтобы писать в чате, <a asp-controller="User" asp-action="Login">войдите</a> или <a
                                        asp-controller="User" asp-action="Register">зарегистрируйтесь</a></p>
                            </div>
                        }
                    </div>
                </div>
            </div>
</body>

</html>